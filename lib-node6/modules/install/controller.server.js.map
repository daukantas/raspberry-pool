{"version":3,"sources":["../../../src/modules/install/controller.server.js"],"names":["installScriptsDir","__dirname","date","Date","CONFIG_PLACEHOLDER","scripts","Map","filter","filename","endsWith","map","slice","toString","index","ctx","websocketPort","app","config","get","render","View","hostname","request","origin","script","assert","method","scriptName","route","namedParams","scriptBody","set","toUTCString","replace","body"],"mappings":";;;;;;AAAA;;AACA;;AACA;;;;;;AAEA,MAAMA,oBAAqB,GAAEC,SAAU,4BAAvC;AACA,MAAMC,OAAO,IAAIC,IAAJ,EAAb;AACA,MAAMC,qBAAqB,6CAA3B;;AAEA,MAAMC,UAAU,IAAIC,GAAJ,CACd,qBAAYN,iBAAZ,EACGO,MADH,CACUC,YAAYA,SAASC,QAAT,CAAkB,KAAlB,CADtB,EAEGC,GAFH,CAEOF,YAAY,CAACA,SAASG,KAAT,CAAe,CAAf,EAAkB,CAAC,CAAnB,CAAD,EAAwB,sBAAc,GAAEX,iBAAkB,GAAEQ,QAAS,EAA7C,EAAgDI,QAAhD,EAAxB,CAFnB,CADc,CAAhB;;kBAMe,wBAAc;AAC3BC,QAAMC,GAAN,EAAW;AACT,UAAMC,gBAAgBD,IAAIE,GAAJ,CAAQC,MAAR,CAAeC,GAAf,CAAmB,WAAnB,EAAgCA,GAAhC,CAAoC,MAApC,CAAtB;AACAJ,QAAIK,MAAJ,CAAW,EAAEC,2BAAF,EAAX,EAAkC,EAAEC,UAAUP,IAAIQ,OAAJ,CAAYC,MAAxB,EAAgCR,aAAhC,EAAlC;AACD,GAJ0B;;AAM3BS,SAAOV,GAAP,EAAY;AACVA,QAAIW,MAAJ,CAAWX,IAAIY,MAAJ,KAAe,MAAf,IAAyBZ,IAAIY,MAAJ,KAAe,KAAnD,EAA0D,GAA1D;AACA,UAAMC,aAAab,IAAIc,KAAJ,CAAUC,WAAV,CAAsBX,GAAtB,CAA0B,YAA1B,CAAnB;AACA,QAAIY,aAAazB,QAAQa,GAAR,CAAYS,UAAZ,CAAjB;AACAb,QAAIW,MAAJ,CAAWK,UAAX,EAAuB,GAAvB;AACAhB,QAAIiB,GAAJ,CAAQ,eAAR,EAAyB7B,KAAK8B,WAAL,EAAzB;;AAEA,QAAIL,eAAe,mBAAnB,EAAwC;AACtCG,mBAAaA,WAAWG,OAAX,CAAmB7B,kBAAnB,EAAwC,QAAOU,IAAIQ,OAAJ,CAAYC,MAAO,oBAAlE,CAAb;AACD,KAFD,MAEO,IAAII,eAAe,gBAAnB,EAAqC;AAC1CG,mBAAaA,WAAWG,OAAX,CACX7B,kBADW,EAEV,oBAAmBU,IAAIQ,OAAJ,CAAYC,MAAO,kBAAiBT,IAAIE,GAAJ,CAAQC,MAAR,CAAeC,GAAf,CAAmB,WAAnB,EAAgCA,GAAhC,CAAoC,MAApC,CAA4C,EAFzF,CAAb;AAID;;AAEDJ,QAAIoB,IAAJ,GAAWJ,UAAX;AACD;AAvB0B,CAAd,C","file":"controller.server.js","sourcesContent":["import { newController } from 'alp';\nimport { readdirSync, readFileSync } from 'fs';\nimport InstallView from './InstallView';\n\nconst installScriptsDir = `${__dirname}/../../../install-scripts/`;\nconst date = new Date();\nconst CONFIG_PLACEHOLDER = '### SERVER CONFIG WILL BE INJECTED HERE ###';\n\nconst scripts = new Map(\n  readdirSync(installScriptsDir)\n    .filter(filename => filename.endsWith('.sh'))\n    .map(filename => [filename.slice(0, -3), readFileSync(`${installScriptsDir}${filename}`).toString()]),\n);\n\nexport default newController({\n  index(ctx) {\n    const websocketPort = ctx.app.config.get('webSocket').get('port');\n    ctx.render({ View: InstallView }, { hostname: ctx.request.origin, websocketPort });\n  },\n\n  script(ctx) {\n    ctx.assert(ctx.method === 'HEAD' || ctx.method === 'GET', 405);\n    const scriptName = ctx.route.namedParams.get('scriptName');\n    let scriptBody = scripts.get(scriptName);\n    ctx.assert(scriptBody, 404);\n    ctx.set('Last-Modified', date.toUTCString());\n\n    if (scriptName === 'install-raspberry') {\n      scriptBody = scriptBody.replace(CONFIG_PLACEHOLDER, `URL=\"${ctx.request.origin}/install-scripts/\"`);\n    } else if (scriptName === 'install-client') {\n      scriptBody = scriptBody.replace(\n        CONFIG_PLACEHOLDER,\n        `SERVER_HOSTNAME=\"${ctx.request.origin}\"\\nSERVER_PORT=${ctx.app.config.get('webSocket').get('port')}`,\n      );\n    }\n\n    ctx.body = scriptBody;\n  },\n});\n"]}