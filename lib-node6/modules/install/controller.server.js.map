{"version":3,"sources":["../../../src/modules/install/controller.server.js"],"names":["installScriptsDir","__dirname","date","Date","CONFIG_PLACEHOLDER","scripts","Map","filter","filename","endsWith","map","slice","toString","index","ctx","render","View","url","request","origin","script","assert","method","scriptName","route","namedParams","get","scriptBody","set","toUTCString","replace","app","config","body"],"mappings":";;;;;;AACA;;AACA;;AACA;;;;;;AAEA,MAAMA,oBAAqB,IAAEC,SAAU,6BAAvC;AACA,MAAMC,OAAO,IAAIC,IAAJ,EAAb;AACA,MAAMC,qBAAqB,6CAA3B;;AAEA,MAAMC,UAAU,IAAIC,GAAJ,CACZ,qBAAYN,iBAAZ,EACKO,MADL,CACYC,YAAYA,SAASC,QAAT,CAAkB,KAAlB,CADxB,EAEKC,GAFL,CAESF,YAAY,CAACA,SAASG,KAAT,CAAe,CAAf,KAAD,EAAwB,sBAAc,IAAEX,iBAAkB,KAAEQ,QAAS,GAA7C,EAAgDI,QAAhD,EAAxB,CAFrB,CADY,CAAhB;;kBAMe,wBAAc;AACzBC,UAAMC,GAAN,EAAW;AACPA,YAAIC,MAAJ,CAAW,EAAEC,2BAAF,EAAX,EAAkC,EAAEC,KAAKH,IAAII,OAAJ,CAAYC,MAAnB,EAAlC;AACH,KAHwB;;AAKzBC,WAAON,GAAP,EAAY;AACRA,YAAIO,MAAJ,CAAWP,IAAIQ,MAAJ,KAAe,MAAf,IAAyBR,IAAIQ,MAAJ,KAAe,KAAnD,EAA0D,GAA1D;AACA,cAAMC,aAAaT,IAAIU,KAAJ,CAAUC,WAAV,CAAsBC,GAAtB,CAA0B,YAA1B,CAAnB;AACA,YAAIC,aAAatB,QAAQqB,GAAR,CAAYH,UAAZ,CAAjB;AACAT,YAAIO,MAAJ,CAAWM,UAAX,EAAuB,GAAvB;AACAb,YAAIc,GAAJ,CAAQ,eAAR,EAAyB1B,KAAK2B,WAAL,EAAzB;;AAEA,YAAIN,eAAe,mBAAnB,EAAwC;AACpCI,yBAAaA,WAAWG,OAAX,CAAmB1B,kBAAnB,EAAwC,SAAOU,IAAII,OAAJ,CAAYC,MAAO,qBAAlE,CAAb;AACH,SAFD,MAEO,IAAII,eAAe,gBAAnB,EAAqC;AACxCI,yBAAaA,WAAWG,OAAX,CACT1B,kBADS,EAER,qBAAmBU,IAAII,OAAJ,CAAYC,MAAO,oBAAiBL,IAAIiB,GAAJ,CAAQC,MAAR,CAAeN,GAAf,CAAmB,WAAnB,EAAgCA,GAAhC,CAAoC,MAApC,CAA4C,GAF3F,CAAb;AAIH;;AAEDZ,YAAImB,IAAJ,GAAWN,UAAX;AACH;AAtBwB,CAAd,C","file":"controller.server.js","sourcesContent":["if (global.BROWSER) throw new Error();\nimport { newController } from 'alp';\nimport { readdirSync, readFileSync } from 'fs';\nimport InstallView from './InstallView';\n\nconst installScriptsDir = `${__dirname}/../../../install-scripts/`;\nconst date = new Date();\nconst CONFIG_PLACEHOLDER = '### SERVER CONFIG WILL BE INJECTED HERE ###';\n\nconst scripts = new Map(\n    readdirSync(installScriptsDir)\n        .filter(filename => filename.endsWith('.sh'))\n        .map(filename => [filename.slice(0, -3), readFileSync(`${installScriptsDir}${filename}`).toString()])\n);\n\nexport default newController({\n    index(ctx) {\n        ctx.render({ View: InstallView }, { url: ctx.request.origin });\n    },\n\n    script(ctx) {\n        ctx.assert(ctx.method === 'HEAD' || ctx.method === 'GET', 405);\n        const scriptName = ctx.route.namedParams.get('scriptName');\n        let scriptBody = scripts.get(scriptName);\n        ctx.assert(scriptBody, 404);\n        ctx.set('Last-Modified', date.toUTCString());\n\n        if (scriptName === 'install-raspberry') {\n            scriptBody = scriptBody.replace(CONFIG_PLACEHOLDER, `URL=\"${ctx.request.origin}/install-scripts/\"`);\n        } else if (scriptName === 'install-client') {\n            scriptBody = scriptBody.replace(\n                CONFIG_PLACEHOLDER,\n                `SERVER_HOSTNAME=\"${ctx.request.origin}\"\\nSERVER_PORT=${ctx.app.config.get('webSocket').get('port')}`\n            );\n        }\n\n        ctx.body = scriptBody;\n    },\n});\n"]}