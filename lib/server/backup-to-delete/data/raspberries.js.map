{"version":3,"sources":["server/backup-to-delete/data/raspberries.js"],"names":[],"mappings":"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","file":"server/backup-to-delete/data/raspberries.js","sourcesContent":["import { readFileSync, writeFileSync } from 'fs';\nimport { writeById } from '../tcp-server';\nimport { slugify as _slugify } from 'transliteration';\n\nconst dataFilename = `${__dirname}/../../data/raspberries.json`;\n\nconst data = JSON.parse(readFileSync(dataFilename));\nexport const items = Object.keys(data).map(key => Object.assign({ id: key, online: false }, data[key]));\nconst map = new Map();\nconst mapByMac = new Map();\n\nconst unknown = new Map();\n\n\nitems.forEach(item => {\n    map.set(item.id, item);\n    Object.keys(item.networks).forEach(mac => {\n        if (mapByMac.has(mac)) {\n            throw new Error(`Mac defined more than one: ${mac}`);\n        }\n\n        mapByMac.set(mac, item);\n    });\n});\n\nfunction save() {\n    writeFileSync(dataFilename, JSON.stringify(data, null, 4));\n}\n\nexport function getById(id) {\n    return map.get(id);\n}\n\nexport function getByMac(mac) {\n    return mapByMac.get(mac);\n}\n\nexport function setOnline(raspberry, { mac, ip }) {\n    raspberry.online = true;\n    raspberry.networks[mac].ip = ip;\n}\n\nexport function setOffline(raspberry, mac) {\n    raspberry.networks[mac].ip = null;\n    raspberry.online = Object.keys(raspberry.networks).some(mac => raspberry.networks[mac].ip);\n}\n\nexport function addUnknown({ mac, ip }) {\n    unknown.set(mac, { mac, ip });\n}\n\nexport function removeUnknown(mac) {\n    return unknown.delete(mac);\n}\n\nexport function getUnknownRaspberries() {\n    return Array.from(unknown.values());\n}\n\nexport function patchRaspberry(raspberry, changes) {\n    const id = raspberry.id;\n\n    changes = Object.assign({}, { url: changes.url.trim() });\n    Object.assign(map.get(id), changes);\n    Object.assign(data[id], changes);\n    save();\n\n    writeById(id, { type: 'update-config', config: changes });\n\n    return changes;\n}\n\nexport function sendAction(raspberry, action) {\n    const id = raspberry.id;\n    writeById(id, { type: 'action', action });\n}\n\nfunction slugify(string) {\n    return _slugify(string, { lowercase: true, separator: '-' });\n}\n\n// ip should not be written\nexport function addNew(mac, name) {\n    const newRaspberryItem = {\n        name,\n        mac,\n        url: '',\n        networks: {\n            [mac]: {},\n        },\n    };\n\n    items.push(newRaspberryItem);\n    const id = slugify(name);\n\n    const newRaspberry = Object.assign({}, newRaspberryItem, {\n        id,\n    });\n\n    return newRaspberry;\n}\n"],"sourceRoot":"/"}