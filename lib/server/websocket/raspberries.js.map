{"version":3,"sources":["server/websocket/raspberries.js"],"names":[],"mappings":";;;;;kBAOwB,I;;AAPxB;;IAAY,kB;;AACZ;;;;;;;;AAEA,MAAM,SAAS,0BAAW,2BAAX,CAAf;;AAEA,IAAI,eAAe,CAAnB;;AAEe,SAAS,IAAT,CAAc,MAAd,EAAsB;AACjC,QAAI,mBAAmB,CAAvB,EAA0B;AACtB,2BAAmB,2BAAnB;AACH;AACD,WAAO,IAAP,CAAY,WAAZ,EAAyB,EAAE,0BAAF,EAAzB;;AAEA,WAAO,EAAP,CAAU,YAAV,EAAwB,MAAM;AAC1B,YAAI,EAAE,YAAF,KAAmB,CAAvB,EAA0B;AACtB,+BAAmB,6BAAnB;AACH;AACD,eAAO,IAAP,CAAY,cAAZ,EAA4B,EAAE,0BAAF,EAA5B;AACH,KALD;;AAOA,WAAO,EAAP,CAAU,uBAAV,EAAoC,QAAD,IAAc;AAC7C,eAAO,IAAP,CAAY,MAAZ;AACA,eAAO,IAAP,CAAY,aAAZ;AACA,iBAAS,EAAE,aAAa,mBAAmB,MAAnB,EAAf,EAAT;AACH,KAJD;;AAMA,WAAO,EAAP,CAAU,yBAAV,EAAqC,MAAM;AACvC,eAAO,IAAP,CAAY,OAAZ;AACA,eAAO,KAAP,CAAa,aAAb;AACH,KAHD;;AAKA,WAAO,EAAP,CAAU,wBAAV,EAAoC,CAAC,EAAD,EAAK,MAAL,EAAa,QAAb,KAA0B;AAC1D,cAAM,YAAY,mBAAmB,YAAnB,CAAgC,EAAhC,EAAoC,MAApC,EAA4C,QAA5C,CAAlB;AACA,YAAI,CAAC,SAAL,EAAgB;AACZ;AACH,SAFD,MAEO;AACH,qBAAS,SAAT;AACA,kBAAM,YAAY,mBAAmB,OAAnB,CAA2B,EAA3B,CAAlB;AACA,mBAAO,SAAP,CAAiB,EAAjB,CAAoB,aAApB,EAAmC,IAAnC,CAAwC,kBAAxC,EAA4D,SAA5D;AACH;AACJ,KATD;;AAWA,WAAO,EAAP,CAAU,sBAAV,EAAkC,CAAC,GAAD,EAAM,MAAN,EAAc,QAAd,KAA2B;AACzD,eAAO,IAAP,CAAY,sBAAZ,EAAoC,EAAE,QAAF,EAAO,cAAP,EAApC;AACA,YAAI,OAAJ,CAAY,MAAM;AACd,kBAAM,YAAY,mBAAmB,UAAnB,CAA8B,EAA9B,EAAkC,MAAlC,CAAlB;AACA,gBAAI,SAAJ,EAAe;AACX,uBAAO,SAAP,CAAiB,EAAjB,CAAoB,aAApB,EAAmC,IAAnC,CAAwC,kBAAxC,EAA4D,SAA5D;AACH;AACJ,SALD;AAMA;AACH,KATD;;AAWA,WAAO,EAAP,CAAU,eAAV,EAA2B,CAAC,GAAD,EAAM,IAAN,EAAY,QAAZ,KAAyB;AAChD,eAAO,IAAP,CAAY,oBAAZ,EAAkC,EAAE,QAAF,EAAO,UAAP,EAAlC;AACA,cAAM,eAAe,mBAAmB,GAAnB,CAAuB,GAAvB,EAA4B,IAA5B,CAArB;AACA,YAAI,CAAC,YAAL,EAAmB;AACf,qBAAS,KAAT;AACH,SAFD,MAEO;AACH,qBAAS,YAAT;AACA,mBAAO,SAAP,CAAiB,EAAjB,CAAoB,aAApB,EAAmC,IAAnC,CAAwC,kBAAxC,EAA4D,YAA5D;AACA,gBAAI,aAAa,EAAb,KAAoB,GAAxB,EAA6B;AACzB,uBAAO,SAAP,CAAiB,EAAjB,CAAoB,aAApB,EAAmC,IAAnC,CAAwC,kBAAxC,EAA4D,YAA5D;AACH;AACJ;AACJ,KAZD;AAaH","file":"server/websocket/raspberries.js","sourcesContent":["import * as raspberriesManager from '../raspberriesManager';\nimport Logger from 'nightingale';\n\nconst logger = new Logger('app.websocket.raspberries');\n\nlet clientsCount = 0;\n\nexport default function init(socket) {\n    if (clientsCount++ === 0) {\n        raspberriesManager.raspberriesClientsConnected();\n    }\n    logger.info('connected', { clientsCount });\n\n    socket.on('disconnect', () => {\n        if (--clientsCount === 0) {\n            raspberriesManager.raspberriesClientsDisonnected();\n        }\n        logger.info('disconnected', { clientsCount });\n    });\n\n    socket.on('subscribe:raspberries', (callback) => {\n        logger.info('join');\n        socket.join('raspberries');\n        callback({ raspberries: raspberriesManager.getAll() });\n    });\n\n    socket.on('unsubscribe:raspberries', () => {\n        logger.info('leave');\n        socket.leave('raspberries');\n    });\n\n    socket.on('raspberry:changeConfig', (id, config, callback) => {\n        const newConfig = raspberriesManager.changeConfig(id, config, callback);\n        if (!newConfig) {\n            callback();\n        } else {\n            callback(newConfig);\n            const raspberry = raspberriesManager.getById(id);\n            socket.broadcast.to('raspberries').emit('raspberry:update', raspberry);\n        }\n    });\n\n    socket.on('raspberry:sendAction', (ids, action, callback) => {\n        logger.info('sendAction raspberry', { ids, action });\n        ids.forEach(id => {\n            const raspberry = raspberriesManager.sendAction(id, action);\n            if (raspberry) {\n                socket.broadcast.to('raspberries').emit('raspberry:update', raspberry);\n            }\n        });\n        callback();\n    });\n\n    socket.on('raspberry:add', (mac, info, callback) => {\n        logger.info('register raspberry', { mac, info });\n        const newRaspberry = raspberriesManager.add(mac, info);\n        if (!newRaspberry) {\n            callback(false);\n        } else {\n            callback(newRaspberry);\n            socket.broadcast.to('raspberries').emit('raspberry:update', newRaspberry);\n            if (newRaspberry.id !== mac) {\n                socket.broadcast.to('raspberries').emit('raspberry:update', newRaspberry);\n            }\n        }\n    });\n}\n"],"sourceRoot":"/"}